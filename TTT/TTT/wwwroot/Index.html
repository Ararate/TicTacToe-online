<!DOCTYPE html>
<html>
<head>
    <style>
        th, tr {
            border: 1px solid black;
            font-size: 80px;
            width: 100px;
            height: 100px;
        }
    </style>
    <meta charset="utf-8" />
    <title>Крестики нолики</title>
</head>
<body>
    <h5 id="message"></h5>
    <span id="error"></span>
    <table>
        <tr>
            <th id="0-0" onclick="Move(0,0)"></th>
            <th id="0-1" onclick="Move(0,1)"></th>
            <th id="0-2" onclick="Move(0,2)"></th>
        </tr>          
        <tr>           
            <th id="1-0" onclick="Move(1,0)"></th>
            <th id="1-1" onclick="Move(1,1)"></th>
            <th id="1-2" onclick="Move(1,2)"></th>
        </tr>   
        <tr>    
            <th id="2-0" onclick="Move(2,0)"></th>
            <th id="2-1" onclick="Move(2,1)"></th>
            <th id="2-2" onclick="Move(2,2)"></th>
        </tr>
    </table>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr/dist/browser/signalr.min.js"></script>
    <script>
        if (!sessionStorage.getItem("tokenKey"))
            document.body.innerHTML = "<b>Необходима <a href='Login.html'>авторизация</a></b>"

        var symbol;
        var opponentSymb;
        if (sessionStorage.getItem("Mover") == sessionStorage.getItem("name")) {
            symbol = "O";
            opponentSymb = "X"
        }
        else {
            symbol = "X";
            opponentSymb = "O"
        }

        const hubConnection = new signalR.HubConnectionBuilder()
            .withUrl("GameHub")
            .build();
        hubConnection.on("GetGameData", (dto) => {
            document.getElementById(dto.x + "-" + dto.y).innerHTML = opponentSymb;
            message.innerHTML = "Сейчас ходит:" + dto.mover;
        });
        hubConnection.on("FinishGame", (dto) => {
            if (dto.draw) {
                message.innerHTML = "Игра завершена! Ничья";
                return;
            }
            message.innerHTML = "Игра завершена! Победитель:" + dto.winner;
        });
        hubConnection.start()
            .then(() =>
                hubConnection.invoke("GetConnectionId", sessionStorage.getItem("tokenKey")));

        const message = document.getElementById("message");
        const error = document.getElementById("error");
        message.innerHTML = "Сейчас ходит:" + sessionStorage.getItem("Mover");

        
        async function Move(x, y) {
            var response = await fetch("Game/MakeMove", {
                method: "POST",
                headers: {
                    "Accept": "application/json",
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + sessionStorage.getItem("tokenKey")
                },
                body: JSON.stringify({
                    "X": x,
                    "Y": y
                })
            });
            if (response.headers.has("Www-Authenticate")) {
                response = await fetch("Player/RefreshTokens", {
                    method: "PUT",
                    headers: { "Accept": "application/json", "Content-Type": "application/json" },
                    body: JSON.stringify({
                        "accessToken": sessionStorage.getItem("tokenKey"),
                        "refreshToken": sessionStorage.getItem("refreshKey")
                    })
                });
                var data = await response.json();
                sessionStorage.setItem("tokenKey", data.accessToken);
                sessionStorage.setItem("refreshKey", data.refreshToken);
                response = await fetch("Game/MakeMove", {
                    method: "POST",
                    headers: {
                        "Accept": "application/json",
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + sessionStorage.getItem("tokenKey")
                    },
                    body: JSON.stringify({
                        "X": x,
                        "Y": y
                    })
                });
            }
            var data = await response.json();
            if (response.ok === true) {
                document.getElementById(x + "-" + y).innerHTML = symbol;
                error.innerHTML = "";
            }
            else
                message.innerHTML = data;
        };
    </script>
</body>
</html>